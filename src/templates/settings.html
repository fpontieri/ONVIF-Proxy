{% extends "base.html" %}

{% block title %}Settings - ONVIF Proxy{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">System Settings</h1>
</div>

<div class="row">
    <div class="col-md-8">
        <form method="POST">
            <!-- System Configuration -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-server"></i> System Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enabled" name="enabled" 
                                   {{ 'checked' if system_config.enabled }}>
                            <label class="form-check-label" for="enabled">
                                <strong>Enable ONVIF Proxy Service</strong>
                            </label>
                            <div class="form-text">Master switch to enable/disable the entire proxy service</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="base_interface" class="form-label">Base Network Interface</label>
                                <select class="form-select" id="base_interface" name="base_interface" required>
                                    {% for interface in interfaces %}
                                    <option value="{{ interface }}" {{ 'selected' if interface == system_config.base_interface }}>
                                        {{ interface }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Network interface to create virtual cameras on</div>
                                <div id="interface-info" class="mt-2"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="web_port" class="form-label">Web Interface Port</label>
                                <input type="number" class="form-control" id="web_port" name="web_port" 
                                       value="{{ system_config.web_port }}" min="1" max="65535" required>
                                <div class="form-text">Port for this web interface</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="base_ip_range" class="form-label">Base IP Range</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="base_ip_range" name="base_ip_range" 
                                   value="{{ system_config.base_ip_range }}" 
                                   pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" required>
                            <button type="button" class="btn btn-outline-secondary" id="suggest-ip-btn" title="Suggest IP based on interface">
                                <i class="fas fa-magic"></i> Auto
                            </button>
                        </div>
                        <div class="form-text">Starting IP address for virtual camera interfaces (e.g., 192.168.1.100)</div>
                        <div id="ip-suggestions" class="mt-2"></div>
                    </div>

                    <div class="mb-3">
                        <label for="ping_interval" class="form-label">Camera Ping Interval</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="ping_interval" name="ping_interval" 
                                   value="{{ system_config.ping_interval or 30 }}" min="10" max="300" required>
                            <span class="input-group-text">seconds</span>
                        </div>
                        <div class="form-text">How often the watchdog should ping each camera (3 pings per interval)</div>
                    </div>
                </div>
            </div>

            <!-- Notification Configuration -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bell"></i> Pushover Notifications
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Pushover Setup:</strong> Get your API token and user key from 
                        <a href="https://pushover.net/" target="_blank" class="alert-link">pushover.net</a>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="pushover_token" class="form-label">API Token</label>
                                <input type="text" class="form-control" id="pushover_token" name="pushover_token" 
                                       value="{{ system_config.pushover_token or '' }}" 
                                       placeholder="Your application API token">
                                <div class="form-text">Application API token from Pushover</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="pushover_user" class="form-label">User Key</label>
                                <input type="text" class="form-control" id="pushover_user" name="pushover_user" 
                                       value="{{ system_config.pushover_user or '' }}" 
                                       placeholder="Your user key">
                                <div class="form-text">Your user key from Pushover</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-primary" onclick="testNotification()">
                            <i class="fas fa-bell"></i> Test Notification
                        </button>
                    </div>

                    <!-- Notification Events Configuration -->
                    <div class="row">
                        <div class="col-12">
                            <h6 class="mb-3">Notification Events</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="notify_camera_offline" name="notify_camera_offline" 
                                                   {{ 'checked' if system_config.notify_camera_offline }}>
                                            <label class="form-check-label" for="notify_camera_offline">
                                                Camera Offline
                                            </label>
                                        </div>
                                        <select class="form-select form-select-sm mt-1" name="notify_camera_offline_priority">
                                            <option value="-2" {{ 'selected' if system_config.notify_camera_offline_priority == -2 }}>Silent</option>
                                            <option value="-1" {{ 'selected' if system_config.notify_camera_offline_priority == -1 }}>Quiet</option>
                                            <option value="0" {{ 'selected' if system_config.notify_camera_offline_priority == 0 or not system_config.notify_camera_offline_priority }}>Normal</option>
                                            <option value="1" {{ 'selected' if system_config.notify_camera_offline_priority == 1 }}>High</option>
                                            <option value="2" {{ 'selected' if system_config.notify_camera_offline_priority == 2 }}>Emergency</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="notify_camera_online" name="notify_camera_online" 
                                                   {{ 'checked' if system_config.notify_camera_online }}>
                                            <label class="form-check-label" for="notify_camera_online">
                                                Camera Online
                                            </label>
                                        </div>
                                        <select class="form-select form-select-sm mt-1" name="notify_camera_online_priority">
                                            <option value="-2" {{ 'selected' if system_config.notify_camera_online_priority == -2 }}>Silent</option>
                                            <option value="-1" {{ 'selected' if system_config.notify_camera_online_priority == -1 }}>Quiet</option>
                                            <option value="0" {{ 'selected' if system_config.notify_camera_online_priority == 0 or not system_config.notify_camera_online_priority }}>Normal</option>
                                            <option value="1" {{ 'selected' if system_config.notify_camera_online_priority == 1 }}>High</option>
                                            <option value="2" {{ 'selected' if system_config.notify_camera_online_priority == 2 }}>Emergency</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="notify_system_error" name="notify_system_error" 
                                                   {{ 'checked' if system_config.notify_system_error }}>
                                            <label class="form-check-label" for="notify_system_error">
                                                System Errors
                                            </label>
                                        </div>
                                        <select class="form-select form-select-sm mt-1" name="notify_system_error_priority">
                                            <option value="-2" {{ 'selected' if system_config.notify_system_error_priority == -2 }}>Silent</option>
                                            <option value="-1" {{ 'selected' if system_config.notify_system_error_priority == -1 }}>Quiet</option>
                                            <option value="0" {{ 'selected' if system_config.notify_system_error_priority == 0 or not system_config.notify_system_error_priority }}>Normal</option>
                                            <option value="1" {{ 'selected' if system_config.notify_system_error_priority == 1 }}>High</option>
                                            <option value="2" {{ 'selected' if system_config.notify_system_error_priority == 2 }}>Emergency</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="notify_service_restart" name="notify_service_restart" 
                                                   {{ 'checked' if system_config.notify_service_restart }}>
                                            <label class="form-check-label" for="notify_service_restart">
                                                Service Restart
                                            </label>
                                        </div>
                                        <select class="form-select form-select-sm mt-1" name="notify_service_restart_priority">
                                            <option value="-2" {{ 'selected' if system_config.notify_service_restart_priority == -2 }}>Silent</option>
                                            <option value="-1" {{ 'selected' if system_config.notify_service_restart_priority == -1 }}>Quiet</option>
                                            <option value="0" {{ 'selected' if system_config.notify_service_restart_priority == 0 or not system_config.notify_service_restart_priority }}>Normal</option>
                                            <option value="1" {{ 'selected' if system_config.notify_service_restart_priority == 1 }}>High</option>
                                            <option value="2" {{ 'selected' if system_config.notify_service_restart_priority == 2 }}>Emergency</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Priority Levels:</strong> Silent (no notification), Quiet (no sound), Normal (default), High (bypass quiet hours), Emergency (repeat until acknowledged)
                    </div>

                    <hr>
                    <h6 class="mb-3">No-Traffic Alerts</h6>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="no_traffic_alerts" name="no_traffic_alerts" 
                                   {{ 'checked' if system_config.get('no_traffic_alerts', True) else '' }}>
                            <label class="form-check-label" for="no_traffic_alerts">
                                <strong>Enable No-Traffic Alerts</strong>
                            </label>
                            <div class="form-text">Send alerts when no traffic is detected from a camera</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="no_traffic_minutes" class="form-label">No-Traffic Threshold</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="no_traffic_minutes" name="no_traffic_minutes" 
                                           value="{{ system_config.get('no_traffic_minutes', 5) }}" min="1" max="1440" required>
                                    <span class="input-group-text">minutes</span>
                                </div>
                                <div class="form-text">Alert if no traffic is detected for this many minutes</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="no_traffic_priority" class="form-label">Alert Priority</label>
                                <select class="form-select" id="no_traffic_priority" name="no_traffic_priority">
                                    <option value="-2" {{ 'selected' if system_config.get('no_traffic_priority', 1) == -2 }}>Silent</option>
                                    <option value="-1" {{ 'selected' if system_config.get('no_traffic_priority', 1) == -1 }}>Quiet</option>
                                    <option value="0" {{ 'selected' if system_config.get('no_traffic_priority', 1) == 0 }}>Normal</option>
                                    <option value="1" {{ 'selected' if system_config.get('no_traffic_priority', 1) == 1 }}>High</option>
                                    <option value="2" {{ 'selected' if system_config.get('no_traffic_priority', 1) == 2 }}>Emergency</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between">
                <a href="{{ url_for('index') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>
        </form>
    </div>

    <div class="col-md-4">
        <!-- System Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle"></i> System Information
                </h6>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <td><strong>Current Status:</strong></td>
                        <td>
                            <span class="badge {{ 'bg-success' if system_config.enabled else 'bg-secondary' }}">
                                {{ 'Enabled' if system_config.enabled else 'Disabled' }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Web Interface:</strong></td>
                        <td>Port {{ system_config.web_port }}</td>
                    </tr>
                    <tr>
                        <td><strong>Base Interface:</strong></td>
                        <td>{{ system_config.base_interface }}</td>
                    </tr>
                    <tr>
                        <td><strong>Notifications:</strong></td>
                        <td>
                            <span class="badge {{ 'bg-success' if system_config.pushover_token and system_config.pushover_user else 'bg-warning' }}">
                                {{ 'Configured' if system_config.pushover_token and system_config.pushover_user else 'Not Configured' }}
                            </span>
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Network Interfaces -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-network-wired"></i> Available Interfaces
                </h6>
            </div>
            <div class="card-body">
                {% if interfaces %}
                    <ul class="list-unstyled mb-0">
                        {% for interface in interfaces %}
                        <li class="mb-1">
                            <i class="fas fa-ethernet text-muted"></i> {{ interface }}
                            {% if interface == system_config.base_interface %}
                                <span class="badge bg-primary ms-1">Current</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted mb-0">No network interfaces found</p>
                {% endif %}
            </div>
        </div>

        <!-- Configuration Tips -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb"></i> Configuration Tips
                </h6>
            </div>
            <div class="card-body">
                <h6>Network Interface:</h6>
                <p class="small text-muted">
                    Choose the network interface that connects to your camera network. Virtual camera interfaces will be created on this interface.
                </p>

                <h6>IP Range:</h6>
                <p class="small text-muted">
                    Set a base IP address in your network range. Each camera will get sequential IPs starting from this address.
                </p>

                <h6>Pushover Notifications:</h6>
                <p class="small text-muted">
                    Get notified when cameras go offline or come back online. Includes ping test results for troubleshooting.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function testNotification() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    button.disabled = true;
    
    fetch('/test_notification', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('danger', data.error);
        }
    })
    .catch(error => {
        showAlert('danger', 'Error: ' + error.message);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Function to update interface information
function updateInterfaceInfo(interfaceName) {
    if (!interfaceName) return;
    
    const infoDiv = document.getElementById('interface-info');
    const suggestionsDiv = document.getElementById('ip-suggestions');
    
    infoDiv.innerHTML = '<small class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading interface info...</small>';
    
    fetch(`/api/interface/${interfaceName}/addresses`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let infoHtml = '';
                if (data.addresses.length > 0) {
                    infoHtml = `<small class="text-success">
                        <i class="fas fa-check-circle"></i> Current IPs: ${data.addresses.join(', ')}
                    </small>`;
                    
                    // Show suggestions
                    if (data.suggested_base) {
                        suggestionsDiv.innerHTML = `
                            <small class="text-info">
                                <i class="fas fa-lightbulb"></i> 
                                Suggested base IP: <strong>${data.suggested_base}</strong>
                                <button type="button" class="btn btn-link btn-sm p-0 ms-1" onclick="useSuggestedIP('${data.suggested_base}')">
                                    Use this
                                </button>
                            </small>`;
                    }
                } else {
                    infoHtml = '<small class="text-warning"><i class="fas fa-exclamation-triangle"></i> No IP addresses found</small>';
                }
                infoDiv.innerHTML = infoHtml;
            } else {
                infoDiv.innerHTML = `<small class="text-danger"><i class="fas fa-times-circle"></i> Error: ${data.error}</small>`;
            }
        })
        .catch(error => {
            infoDiv.innerHTML = `<small class="text-danger"><i class="fas fa-times-circle"></i> Failed to load interface info</small>`;
        });
}

// Function to use suggested IP
function useSuggestedIP(ip) {
    document.getElementById('base_ip_range').value = ip;
    document.getElementById('ip-suggestions').innerHTML = '<small class="text-success"><i class="fas fa-check"></i> IP updated!</small>';
    setTimeout(() => {
        document.getElementById('ip-suggestions').innerHTML = '';
    }, 2000);
}

// Auto-suggest IP based on selected interface
document.getElementById('suggest-ip-btn').addEventListener('click', function() {
    const selectedInterface = document.getElementById('base_interface').value;
    if (selectedInterface) {
        updateInterfaceInfo(selectedInterface);
    }
});

// Update interface info when selection changes
document.getElementById('base_interface').addEventListener('change', function() {
    updateInterfaceInfo(this.value);
});

// Load initial interface info
document.addEventListener('DOMContentLoaded', function() {
    const currentInterface = document.getElementById('base_interface').value;
    if (currentInterface) {
        updateInterfaceInfo(currentInterface);
    }
});

// Validate IP address format
document.getElementById('base_ip_range').addEventListener('blur', function() {
    const ip = this.value;
    const ipRegex = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
    
    if (ip && !ipRegex.test(ip)) {
        showAlert('warning', 'Please enter a valid IP address format (e.g., 192.168.1.100)');
        this.focus();
    }
});

// Warn about port changes
document.getElementById('web_port').addEventListener('change', function() {
    const currentPort = parseInt('{{ system_config.web_port|default(8080) }}');
    const newPort = parseInt(this.value);
    
    if (newPort !== currentPort) {
        showAlert('warning', `After saving, the web interface will be available on port ${newPort}. You may need to update your bookmark.`);
    }
});
</script>
{% endblock %}
