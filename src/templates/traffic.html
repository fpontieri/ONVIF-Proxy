{% extends "base.html" %}

{% block title %}Traffic Monitor - {{ camera.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-chart-line"></i>
                    Traffic Monitor - {{ camera.name }}
                </h2>
                <div>
                    <a href="{{ url_for('cameras') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Cameras
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Stats -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-tachometer-alt"></i> Current Traffic Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Period</th>
                                    <th>RX Bytes/sec</th>
                                    <th>TX Bytes/sec</th>
                                    <th>RX Packets/sec</th>
                                    <th>TX Packets/sec</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>5-Minute Average</strong></td>
                                    <td id="rx-bytes-5min">--</td>
                                    <td id="tx-bytes-5min">--</td>
                                    <td id="rx-packets-5min">--</td>
                                    <td id="tx-packets-5min">--</td>
                                </tr>
                            </tbody>
                        </table>
                        <table class="table table-bordered mt-3">
                            <thead class="table-light">
                                <tr>
                                    <th>Period</th>
                                    <th>Total RX Bytes</th>
                                    <th>Total TX Bytes</th>
                                    <th>Total RX Packets</th>
                                    <th>Total TX Packets</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>24-Hour Total</strong></td>
                                    <td id="total-rx-bytes-24h">--</td>
                                    <td id="total-tx-bytes-24h">--</td>
                                    <td id="total-rx-packets-24h">--</td>
                                    <td id="total-tx-packets-24h">--</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Traffic -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-tachometer-alt"></i> Real-time Traffic</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="realtime-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Historical Traffic Graphs -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-chart-area"></i> Historical Traffic</h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary active" data-range="-1h">1 Hour</button>
                            <button type="button" class="btn btn-outline-primary" data-range="-6h">6 Hours</button>
                            <button type="button" class="btn btn-outline-primary" data-range="-1d">1 Day</button>
                            <button type="button" class="btn btn-outline-primary" data-range="-1w">1 Week</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="text-center" id="graph-loading">
                        <div class="spinner-border" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2">Loading traffic graph...</p>
                    </div>
                    <div id="graph-container" style="display: none;">
                        <img id="traffic-graph" class="img-fluid" alt="Traffic Graph" />
                    </div>
                    <div id="graph-error" class="alert alert-warning" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Unable to load traffic graph. This may be because:
                        <ul class="mb-0 mt-2">
                            <li>Traffic monitoring is not yet initialized</li>
                            <li>No traffic data is available for this camera</li>
                            <li>RRD tools are not installed</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Chart -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Real-time Traffic (Last 5 Minutes)</h5>
                </div>
                <div class="card-body">
                    <canvas id="realtime-chart" width="800" height="400"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.stat-box {
    padding: 15px;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    margin-bottom: 10px;
}

.stat-value {
    font-size: 1.5em;
    font-weight: bold;
    color: #007bff;
    display: block;
}

#traffic-graph {
    max-width: 100%;
    height: auto;
}

.btn-group .btn.active {
    background-color: #007bff;
    color: white;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
let currentRange = '-1h';
let realtimeData = {
    labels: [],
    datasets: [
        {
            label: 'RX Bytes/s',
            data: [],
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderWidth: 2,
            tension: 0.1,
            fill: true
        },
        {
            label: 'TX Bytes/s',
            data: [],
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderWidth: 2,
            tension: 0.1,
            fill: true
        }
    ]
};

let realtimeChart;
let lastRxBytes = 0;
let lastTxBytes = 0;
let lastUpdateTime = Date.now();
const MAX_POINTS = 60; // Keep last 60 data points (1 minute at 1s intervals)

// Initialize real-time chart
function initRealtimeChart() {
    const ctx = document.getElementById('realtime-chart').getContext('2d');
    
    realtimeChart = new Chart(ctx, {
        type: 'line',
        data: realtimeData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 0 // Disable animations for better performance
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            scales: {
                x: {
                    type: 'realtime',
                    realtime: {
                        duration: 60000, // Show 60 seconds of data
                        refresh: 1000,   // Update every second
                        delay: 100,      // Small delay for smoother updates
                        onRefresh: updateRealtimeData
                    },
                    time: {
                        displayFormats: {
                            second: 'HH:mm:ss'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Time'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Bytes per Second'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            }
        }
    });
}

// Update real-time data
function updateRealtimeData(chart) {
    const now = Date.now();
    fetch(`/api/camera/{{ camera.id }}/traffic/current`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const timeElapsed = (now - lastUpdateTime) / 1000; // in seconds
                lastUpdateTime = now;
                
                // Calculate bytes per second
                const rxRate = lastRxBytes > 0 ? (data.rx_bytes - lastRxBytes) / timeElapsed : 0;
                const txRate = lastTxBytes > 0 ? (data.tx_bytes - lastTxBytes) / timeElapsed : 0;
                
                // Update last values
                lastRxBytes = data.rx_bytes;
                lastTxBytes = data.tx_bytes;
                
                // Add new data point
                const time = new Date(now);
                
                // Add to chart data
                chart.data.labels.push(time);
                chart.data.datasets[0].data.push({x: time, y: rxRate});
                chart.data.datasets[1].data.push({x: time, y: txRate});
                
                // Remove old data points
                if (chart.data.labels.length > MAX_POINTS) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                    chart.data.datasets[1].data.shift();
                }
                
                // Update chart
                chart.update('none'); // 'none' for better performance
            }
        })
        .catch(error => {
            console.error('Error updating real-time data:', error);
        });
}

// Load traffic graph
function loadTrafficGraph(range = '-1h') {
    currentRange = range;
    
    document.getElementById('graph-loading').style.display = 'block';
    document.getElementById('graph-container').style.display = 'none';
    document.getElementById('graph-error').style.display = 'none';
    
    const graphUrl = `/api/camera/{{ camera.id }}/traffic/graph?range=${range}&width=800&height=400&t=${Date.now()}`;
    
    fetch(graphUrl)
        .then(response => {
            if (response.ok) {
                return response.blob();
            } else {
                throw new Error('Failed to load graph');
            }
        })
        .then(blob => {
            const imageUrl = URL.createObjectURL(blob);
            document.getElementById('traffic-graph').src = imageUrl;
            document.getElementById('graph-loading').style.display = 'none';
            document.getElementById('graph-container').style.display = 'block';
        })
        .catch(error => {
            console.error('Error loading graph:', error);
            document.getElementById('graph-loading').style.display = 'none';
            document.getElementById('graph-error').style.display = 'block';
        });
}

// Update current statistics
function updateCurrentStats() {
    fetch(`/api/camera/{{ camera.id }}/traffic/summary`)
        .then(response => response.json())
        .then(data => {
            if (data.averages_5min && data.totals_24h) {
                const avg5min = data.averages_5min;
                const totals24h = data.totals_24h;
                
                // Update 5-minute averages
                document.getElementById('rx-bytes-5min').textContent = formatBytes(avg5min.rx_bytes_per_sec || 0) + '/s';
                document.getElementById('tx-bytes-5min').textContent = formatBytes(avg5min.tx_bytes_per_sec || 0) + '/s';
                document.getElementById('rx-packets-5min').textContent = (avg5min.rx_packets_per_sec || 0).toFixed(1) + '/s';
                document.getElementById('tx-packets-5min').textContent = (avg5min.tx_packets_per_sec || 0).toFixed(1) + '/s';
                
                // Update 24-hour totals
                document.getElementById('total-rx-bytes-24h').textContent = formatBytes(totals24h.rx_bytes || 0);
                document.getElementById('total-tx-bytes-24h').textContent = formatBytes(totals24h.tx_bytes || 0);
                document.getElementById('total-rx-packets-24h').textContent = (totals24h.rx_packets || 0).toLocaleString();
                document.getElementById('total-tx-packets-24h').textContent = (totals24h.tx_packets || 0).toLocaleString();
                
                // Update real-time chart with current rates
                const now = new Date();
                realtimeData.labels.push(now);
                realtimeData.datasets[0].data.push(avg5min.rx_bytes_per_sec || 0);
                realtimeData.datasets[1].data.push(avg5min.tx_bytes_per_sec || 0);
                
                // Keep only last 60 data points (5 minutes at 5-second intervals)
                if (realtimeData.labels.length > 60) {
                    realtimeData.labels.shift();
                    realtimeData.datasets[0].data.shift();
                    realtimeData.datasets[1].data.shift();
                }
                
                realtimeChart.update('none');
            }
        })
        .catch(error => {
            console.error('Error updating stats:', error);
        });
}

// Format bytes for display
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Initialize chart
    initRealtimeChart();
    
    // Load initial graph
    loadTrafficGraph();
    
    // Update stats immediately and then every 5 seconds
    updateCurrentStats();
    setInterval(updateCurrentStats, 5000);
    
    // Reload graph every 60 seconds
    setInterval(() => loadTrafficGraph(currentRange), 60000);
    
    // Range button handlers
    document.querySelectorAll('[data-range]').forEach(button => {
        button.addEventListener('click', function() {
            // Update active button
            document.querySelectorAll('[data-range]').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Load new graph
            loadTrafficGraph(this.dataset.range);
        });
    });
});
</script>
{% endblock %}
